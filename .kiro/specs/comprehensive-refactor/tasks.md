# 笔记同步系统全面重构实施计划

## 概述

本实施计划将现有的笔记同步系统进行全面重构，集成已实现但未使用的功能模块，并添加多笔记支持和历史版本增强功能。实施将分为 5 个阶段，每个阶段都有明确的验收标准。

## 任务列表

### 第一阶段：修复现有测试和基础设施

- [x] 1. 修复 LocalStorageAdapter 测试失败
  - [x] 1.1 修复版本号递增逻辑
    - 修改 `saveNote` 方法，在保存前读取现有笔记并递增版本号
    - 确保新笔记从版本 1 开始
    - _需求: 7.2_
  - [x] 1.2 编写版本号递增的属性测试
    - **Property 11: 版本号递增正确性**
    - **Validates: Requirements 7.2**
  - [x] 1.3 修复历史清理返回值
    - 修改 `cleanupHistory` 方法，正确计算并返回删除的条目数
    - _需求: 7.3_
  - [x] 1.4 修复数据验证逻辑
    - 加强 `saveNote` 的输入验证，拒绝缺少必需字段的笔记
    - 抛出描述性错误信息
    - _需求: 7.4_
  - [x] 1.5 编写数据验证的属性测试
    - **Property 12: 数据验证拒绝无效输入**
    - **Validates: Requirements 7.4**

- [x] 2. 检查点 - 确保所有现有测试通过
  - 运行完整测试套件，确保所有测试通过
  - 询问用户是否有问题

### 第二阶段：存储系统集成

- [-] 3. 创建 useStorage Hook
  - [x] 3.1 实现 useStorage Hook 基础结构
    - 创建 `brave-sync-notes/client/src/hooks/useStorage.js`
    - 实现初始化逻辑，自动检测 IndexedDB 可用性
    - 实现存储类型切换逻辑
    - _需求: 1.1, 1.2_
  - [ ] 3.2 编写存储往返一致性的属性测试
    - **Property 1: 存储往返一致性**
    - **Validates: Requirements 1.3, 1.4**
  - [x] 3.3 实现笔记 CRUD 操作
    - 实现 `saveNote`, `getNote`, `getAllNotes`, `deleteNote` 方法
    - 集成现有的 StorageManager
    - _需求: 1.3, 1.4_
  - [x] 3.4 实现历史记录操作
    - 实现 `saveHistory`, `getHistory`, `cleanupHistory` 方法
    - 添加历史条目数量限制（50 条）
    - _需求: 5.5_
  - [ ] 3.5 编写历史版本限制的属性测试
    - **Property 9: 历史版本限制**
    - **Validates: Requirements 5.5**

- [x] 4. 集成存储系统到主应用
  - [-] 4.1 更新 Zustand Store
    - 添加存储状态字段：`storageInitialized`, `storageType`
    - 添加存储操作方法
    - _需求: 1.1_
  - [ ] 4.2 在 App.jsx 中初始化存储
    - 在应用启动时初始化 StorageManager
    - 显示存储初始化状态
    - _需求: 1.1, 1.4_
  - [ ] 4.3 实现自动保存功能
    - 在笔记编辑时自动保存到本地存储
    - 使用防抖避免频繁写入
    - _需求: 1.3_
  - [ ] 4.4 实现数据恢复功能
    - 在应用启动时从本地存储恢复数据
    - 处理存储配额超限情况
    - _需求: 1.4, 1.5_

- [ ] 5. 检查点 - 存储系统集成验收
  - 确保所有测试通过，询问用户是否有问题

### 第三阶段：离线模式支持

- [-] 6. 实现离线队列系统
  - [x] 6.1 创建 OfflineQueue 类
    - 创建 `brave-sync-notes/client/src/utils/offline/OfflineQueue.js`
    - 实现操作入队、出队、持久化逻辑
    - _需求: 3.2_
  - [ ] 6.2 编写离线队列顺序保持的属性测试
    - **Property 5: 离线队列顺序保持**
    - **Validates: Requirements 3.2, 3.3**
  - [x] 6.3 创建 useOffline Hook
    - 创建 `brave-sync-notes/client/src/hooks/useOffline.js`
    - 实现网络状态监控
    - 实现离线队列管理
    - _需求: 3.1, 3.2_

- [ ] 7. 集成离线模式到主应用
  - [ ] 7.1 更新 useSocket Hook
    - 集成离线队列，在离线时将操作加入队列
    - 在重连时自动处理队列
    - _需求: 3.3, 3.4_
  - [ ] 7.2 添加离线状态指示器
    - 在 Header 组件中显示离线状态
    - 显示离线队列大小
    - _需求: 3.1_
  - [ ] 7.3 处理离线冲突
    - 在重连时检测离线更改与服务器数据的冲突
    - 触发冲突解决流程
    - _需求: 3.4_

- [ ] 8. 检查点 - 离线模式验收
  - 确保所有测试通过，询问用户是否有问题

### 第四阶段：多笔记支持

- [ ] 9. 实现多笔记数据模型
  - [ ] 9.1 更新 Zustand Store 支持多笔记
    - 添加 `notes` 数组和 `activeNoteId` 状态
    - 实现 `addNote`, `updateNote`, `removeNote`, `setActiveNoteId` 方法
    - _需求: 4.1, 4.2, 4.3_
  - [ ] 9.2 编写笔记唯一标识符的属性测试
    - **Property 6: 笔记唯一标识符**
    - **Validates: Requirements 4.1**
  - [ ] 9.3 实现笔记切换逻辑
    - 在切换笔记时保存当前笔记
    - 加载选中的笔记内容
    - _需求: 4.2_
  - [ ] 9.4 编写笔记切换数据保持的属性测试
    - **Property 7: 笔记切换数据保持**
    - **Validates: Requirements 4.2**

- [ ] 10. 创建 NoteList 组件
  - [ ] 10.1 实现 NoteList 基础组件
    - 创建 `brave-sync-notes/client/src/components/NoteList/NoteList.jsx`
    - 显示笔记列表，支持选择、创建、删除
    - _需求: 4.1, 4.3, 4.5_
  - [ ] 10.2 编写笔记排序正确性的属性测试
    - **Property 8: 笔记排序正确性**
    - **Validates: Requirements 4.5**
  - [ ] 10.3 实现笔记搜索功能
    - 添加搜索输入框
    - 按标题和内容过滤笔记
    - _需求: 4.6_
  - [ ] 10.4 实现笔记重命名功能
    - 添加重命名对话框
    - 同步重命名到所有设备
    - _需求: 4.4_

- [ ] 11. 集成多笔记到 Sidebar
  - [ ] 11.1 更新 Sidebar 组件
    - 集成 NoteList 组件
    - 添加新建笔记按钮
    - _需求: 4.1, 4.5_
  - [ ] 11.2 更新 useSocket 支持多笔记同步
    - 修改同步逻辑以支持多个笔记
    - 添加笔记 ID 到同步消息
    - _需求: 4.2, 4.4_

- [ ] 12. 检查点 - 多笔记支持验收
  - 确保所有测试通过，询问用户是否有问题

### 第五阶段：历史版本增强和 UI 改进

- [ ] 13. 增强历史版本功能
  - [ ] 13.1 创建 HistoryDiff 组件
    - 创建 `brave-sync-notes/client/src/components/History/HistoryDiff.jsx`
    - 实现版本差异对比视图
    - 高亮显示添加和删除的内容
    - _需求: 5.3_
  - [ ] 13.2 增强历史记录面板
    - 更新 Sidebar 中的历史记录显示
    - 添加版本选择和对比功能
    - _需求: 5.1, 5.2_
  - [ ] 13.3 实现版本恢复功能
    - 添加恢复按钮
    - 恢复时创建新的历史条目
    - _需求: 5.4_
  - [ ] 13.4 编写版本恢复完整性的属性测试
    - **Property 10: 版本恢复完整性**
    - **Validates: Requirements 5.4**

- [ ] 14. UI 状态改进
  - [ ] 14.1 增强连接状态显示
    - 更新 Header 显示详细的连接状态
    - 添加状态图标和颜色指示
    - _需求: 6.1, 6.2_
  - [ ] 14.2 改进错误处理 UI
    - 添加用户友好的错误消息
    - 提供恢复选项
    - _需求: 6.3_
  - [ ] 14.3 增强成员列表显示
    - 添加设备详情悬停提示
    - 显示连接时间
    - _需求: 6.4_
  - [ ] 14.4 修复侧边栏状态持久化
    - 确保侧边栏折叠状态在会话间保持
    - _需求: 6.5_

- [ ] 15. 最终检查点 - 项目完成验收
  - 运行完整测试套件
  - 确保所有属性测试通过
  - 询问用户是否有问题

## 实施说明

### 技术栈

- **前端**: React 18 + Vite + Tailwind CSS
- **状态管理**: Zustand
- **编辑器**: CodeMirror 6
- **测试**: Vitest + fast-check
- **存储**: IndexedDB (主) + LocalStorage (备用)

### 开发原则

1. **渐进式集成**: 每个阶段都是独立可测试的
2. **测试驱动**: 每个功能都有对应的测试
3. **向后兼容**: 不破坏现有功能
4. **用户体验优先**: 保持界面流畅响应

### 注意事项

- 所有任务都是必需的，包括属性测试
- 每个检查点都需要确保所有测试通过
- 如果发现设计问题，应返回设计阶段进行调整

